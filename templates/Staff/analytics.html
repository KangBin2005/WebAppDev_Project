{% extends "Staff/Staff_base.html" %}
{% block title %}Analytics Dashboard{% endblock %}

{% block content %}
<!-- MAIN CONTAINER -->
<div class="container mt-4">

  <!-- DASHBOARD HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Analytics Dashboard</h2>
    <!-- Current date display -->
    <small class="text-muted">
      <i class="fas fa-calendar-alt me-1"></i>
      <span id="current-date"></span>
    </small>
  </div>

   <!-- Full-width Bar Chart Row -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">
            <i class="fas fa-running text-primary me-2"></i>
            Activity Participation
          </h5>
          <canvas id="activityChart" height="100"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Pie Charts Row (2 columns) -->
  <div class="row">
    <!-- Participant Enquiries -->
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title">
            <i class="fas fa-comments text-success me-2"></i>
            Participant Enquiries
          </h5>
          <canvas id="participantEnquiryPieChart" height="100"></canvas>
        </div>
      </div>
    </div>

    <!-- Public Enquiries -->
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title">
            <i class="fas fa-globe text-info me-2"></i>
            Public Enquiries
          </h5>
          <canvas id="publicEnquiryPieChart" height="100"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- STYLES -->
<style>
  /* Card styling */
  .card {
    border-radius: 8px;
    border: none;
  }
  .card-title {
    font-weight: 600;
  }
  /* Icon colors */
  .text-primary { color: #4285F4; }
  .text-success { color: #34A853; }
  .text-info { color: #17a2b8; }
</style>

<!-- SCRIPTS -->
<!-- Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<script>
  // ====================
  // COLOR CONFIGURATION
  // ====================
  // Array of colors for chart elements (bars/pie slices)
  // Each color has RGBA values with 0.7 opacity (70% transparent)
  const colors = [
    'rgba(255, 99, 132, 0.7)',    // Red
    'rgba(54, 162, 235, 0.7)',     // Blue
    'rgba(255, 206, 86, 0.7)',     // Yellow
    'rgba(75, 192, 192, 0.7)',     // Teal
    'rgba(153, 102, 255, 0.7)',    // Purple
    'rgba(255, 159, 64, 0.7)',     // Orange
    'rgba(201, 203, 207, 0.7)'     // Gray
  ];

  // ====================
  // UTILITY FUNCTIONS
  // ====================
  // Display current date in the dashboard header
  // Formats date as "Jan 1, 2023" style
  document.getElementById('current-date').textContent =
    new Date().toLocaleDateString('en-US', {
      year: 'numeric',  // Show full year (2023)
      month: 'short',   // Short month name (Jan)
      day: 'numeric'    // Day of month (1-31)
    });

  // ====================
  // CHART 1: ACTIVITY PARTICIPATION (HORIZONTAL BAR CHART)
  // ====================

  // Get the canvas element and its 2D drawing context
  const activityCtx = document.getElementById('activityChart').getContext('2d');

  // Create new Chart.js instance for activity participation
  new Chart(activityCtx, {
    type: 'bar',  // Specifies this is a bar chart
    data: {
      // Single empty label for Y-axis (since we're using horizontal bars)
      labels: [''],

      // Create dataset for each activity using map()
      datasets: {{ activity_names | tojson }}.map((name, i) => ({
        label: name,  // Activity name from Flask template
        // Participation count wrapped in array (required for horizontal bars)
        data: [{{ signup_counts | tojson }}[i]],
        // Assign color from palette using modulo to cycle through colors
        backgroundColor: colors[i % colors.length],
        // Border color same as fill but with full opacity
        borderColor: colors[i % colors.length],
        borderWidth: 1  // 1px border around bars
      }))
    },
    options: {
      indexAxis: 'y',  // Makes bars horizontal (default is vertical)
      responsive: true,  // Chart will resize with container

      // Chart plugins configuration
      plugins: {
        legend: {
          display: true,  // Show the legend
          position: 'right',  // Place legend on right side
          labels: {
            boxWidth: 10  // Width of color indicator boxes in legend
          }
        },
        // Customize tooltip content
        tooltip: {
          callbacks: {
            // Format tooltip to show "Activity: Count" format
            label: ctx => `${ctx.dataset.label}: ${ctx.dataset.data[0]}`
          }
        }
      },

      // Axis configurations
      scales: {
        x: {  // Bottom axis (shows participant counts)
          beginAtZero: true,  // Axis starts at 0
          title: {
            display: true,
            text: 'Number of Participants'  // X-axis label
          },
          ticks: {
            stepSize: 1  // Show every integer value
          }
        },
        y: {  // Left axis (would show activity names but hidden)
          title: {
            display: true,
            text: 'Activity Name'  // Y-axis label
          },
          ticks: {
            display: false  // Hide the dummy label we set earlier
          }
        }
      }
    }
  });

  // ====================
  // CHART 2: PARTICIPANT ENQUIRIES (PIE CHART)
  // ====================

  // Get canvas context for participant enquiries chart
  const participantCtx = document.getElementById('participantEnquiryPieChart').getContext('2d');

  // Create pie chart instance
  new Chart(participantCtx, {
    type: 'pie',  // Specifies pie chart type
    data: {
      // Labels from Flask template (enquiry subjects)
      labels: {{ participant_subject_labels | tojson }},
      datasets: [{
        // Data values from Flask template (count per subject)
        data: {{ participant_subject_values | tojson }},
        // Assign colors from palette
        backgroundColor: colors,
        // Create border colors by making fill colors fully opaque
        borderColor: colors.map(c => c.replace('0.7', '1')),
        borderWidth: 1  // 1px border around slices
      }]
    },
    options: {
      responsive: true,  // Responsive sizing
      plugins: {
        legend: {
          position: 'right',  // Legend on right side
          labels: {
            boxWidth: 12  // Color box size in legend
          }
        },
        // Custom tooltip showing count and percentage
        tooltip: {
          callbacks: {
            label: ctx => {
              // Calculate total of all values
              const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
              // Calculate percentage (rounded to nearest integer)
              const percentage = Math.round((ctx.raw / total) * 100);
              // Format as "Subject: Count (Percentage%)"
              return `${ctx.label}: ${ctx.raw} (${percentage}%)`;
            }
          }
        }
      }
    }
  });

  // ====================
  // CHART 3: PUBLIC ENQUIRIES (PIE CHART)
  // ====================

  // Get canvas context for public enquiries chart
  const publicCtx = document.getElementById('publicEnquiryPieChart').getContext('2d');

  // Create pie chart instance (same structure as participant enquiries)
  new Chart(publicCtx, {
    type: 'pie',
    data: {
      labels: {{ public_subject_labels | tojson }},
      datasets: [{
        data: {{ public_subject_values | tojson }},
        backgroundColor: colors,
        borderColor: colors.map(c => c.replace('0.7', '1')),
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'right',
          labels: {
            boxWidth: 12
          }
        },
        tooltip: {
          callbacks: {
            label: ctx => {
              const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = Math.round((ctx.raw / total) * 100);
              return `${ctx.label}: ${ctx.raw} (${percentage}%)`;
            }
          }
        }
      }
    }
  });
</script>

{% endblock %}